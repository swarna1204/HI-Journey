<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hyper Island Journey ‚Äî Immersive A-Frame Experience</title>
    <link rel="icon" href="data:," /> <!-- Prevent favicon 404 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        body {
            cursor: default;
        }

        #buttons {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
            flex-wrap: wrap;
            pointer-events: auto;
        }

        #backButton {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }

        .zoomButton {
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            color: #222831;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            opacity: 0.5;
        }

        .zoomButton.enabled {
            opacity: 1;
        }

        #storyOverlay {
            display: none;
            position: fixed;
            left: 50%;
            top: 110px;
            transform: translateX(-50%);
            background: rgba(34, 40, 49, 0.95);
            color: #fff;
            font-size: 1.5rem;
            max-width: 80vw;
            padding: 1.3rem 2.3rem;
            border-radius: 18px;
            box-shadow: 0 4px 32px #111a;
            z-index: 99999 !important;
            text-align: center;
            letter-spacing: 0.03em;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="buttons">
        <div class="zoomButton" data-target="monitor001_3">Monitor</div>
        <div class="zoomButton" data-target="bed">Bed</div>
        <div class="zoomButton" data-target="houseplant_1">Plant</div>
        <div class="zoomButton" data-target="Rack001_1">YT Frame</div>
        <div class="zoomButton" data-target="Cylinder001">Wall Frame</div>
        <div class="zoomButton" data-target="Speaker_1">Speaker</div>
        <div class="zoomButton" data-target="Cube011_1">Light</div>
    </div>

    <div id="backButton">Back</div>
    <div id="storyOverlay"></div>

    <audio id="bg-music" src="audio/musicbg.mp3" loop></audio>

    <a-scene id="scene" vr-mode-ui="enabled: true" cursor="rayOrigin: mouse"
        renderer="antialias: true; precision: high;">
        <a-sky color="#222831"></a-sky>
        <a-entity light="type: ambient; intensity: 1"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="5 10 5"></a-entity>

        <a-assets>
            <a-asset-item id="roomModel" src="model/model.glb"></a-asset-item>
        </a-assets>

        <a-entity id="model" class="clickable" gltf-model="#roomModel" position="-5 -10 -5" scale="10 10 10"></a-entity>

        <a-entity id="cameraRig" position="0 4 10">
            <a-camera look-controls wasd-controls>
                <a-cursor position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: white; shader: flat" raycaster="objects: .clickable">
                </a-cursor>
            </a-camera>

            <!-- VR Controllers -->
            <a-entity id="leftHand" hand-controls="hand: left" laser-controls="hand: left"
                raycaster="objects: .clickable; far: 20;" line="visible: false">
            </a-entity>
            <a-entity id="rightHand" hand-controls="hand: right" laser-controls="hand: right"
                raycaster="objects: .clickable; far: 20;" line="visible: false">
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        const audio = document.getElementById('bg-music');
        window.addEventListener('click', function playAudioOnce() {
            if (audio && audio.paused) {
                audio.play();
                window.removeEventListener('click', playAudioOnce);
            }
        });

        const sceneEl = document.querySelector('a-scene');
        const modelEl = document.querySelector('#model');
        const cameraEl = document.querySelector('#cameraRig');
        const zoomButtons = document.querySelectorAll('.zoomButton');
        const backButton = document.getElementById('backButton');
        const storyOverlay = document.getElementById('storyOverlay');
        const clickableObjects = {};

        const leftHand = document.querySelector('#leftHand');
        const rightHand = document.querySelector('#rightHand');

        const defaultCameraPos = new THREE.Vector3(0, 4, 10);
        const defaultCameraQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0));

        const zoomDistances = {
            'Speaker_1': 3,
            'Cube011_1': 4,
            'default': 3.5
        };

        function showStory(text) {
            storyOverlay.innerHTML = text;
            storyOverlay.style.display = "block";
            console.log("showStory called with text:", text);
        }

        function hideStory() {
            storyOverlay.style.display = "none";
        }

        function showStoryForMesh(meshName) {
            if (!meshName) return;
            const lower = meshName.toLowerCase();

            if (lower.includes("bed")) {
                showStory("üõèÔ∏è <b>The Bed</b><br>Balancing motherhood and ambition‚Äîmy journey was about family as much as career.");
            } else if (lower.includes("monitor")) {
                showStory("üíª <b>The Monitor</b><br>Countless late nights learning, coding, and applying for jobs.");
            } else if (lower.includes("plant")) {
                showStory("ü™¥ <b>The Plant</b><br>Roots take time. I was growing quietly in a new city.");
            } else if (lower.includes("rack")) {
                showStory("üé¨ <b>YouTube Frame</b><br>YouTube was my classroom‚Äîwhere I learned to code and stayed inspired.");
            } else if (lower.includes("cylinder")) {
                showStory("üñºÔ∏è <b>Wall Frame</b><br>Daily reminder of lessons learned and milestones achieved.");
            } else if (lower.includes("speaker")) {
                showStory("üîä <b>Speaker</b><br>Podcasts and music fueled my resilience and hope.");
            } else if (lower.includes("cube011")) {
                showStory("üí° <b>Light</b><br>Hyper Island gave me wings. I‚Äôm ready to fly.");
            } else {
                showStory("‚ú® <b>Something in the Room</b><br>This object is not a main story item, but still matters.");
            }
        }

        function handleMeshClick(meshName) {
            focusOnObject(meshName);
            showStoryForMesh(meshName);
        }

        zoomButtons.forEach(btn => {
            btn.classList.remove('enabled');
        });

        modelEl.addEventListener('model-loaded', () => {
            const model = modelEl.getObject3D('mesh');
            model.traverse(node => {
                if (node.isMesh) {
                    clickableObjects[node.name] = node;
                    node.userData.clickable = true;
                }
            });

            zoomButtons.forEach(btn => {
                btn.classList.add('enabled');
            });

            setTimeout(() => {
                showStory("üå± <b>A New City, A New Start</b><br><span style='font-size:1rem;opacity:0.82'>My Hyper Island journey began here, where everything felt new and full of hope.</span>");
            }, 700);
        });

        zoomButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!button.classList.contains('enabled')) return;
                handleMeshClick(button.dataset.target);
            });
        });

        [leftHand, rightHand].forEach(hand => {
            hand.addEventListener('triggerdown', evt => {
                const intersection = hand.components.raycaster.getIntersection(modelEl);
                if (intersection && intersection.object && intersection.object.name) {
                    handleMeshClick(intersection.object.name);
                }
            });

            hand.addEventListener('click', evt => {
                const i = evt.detail.intersection;
                if (i && i.object && i.object.name) {
                    handleMeshClick(i.object.name);
                }
            });
        });

        modelEl.addEventListener('click', evt => {
            const meshName = evt.detail.intersection?.object?.name;
            if (meshName) handleMeshClick(meshName);
        });

        sceneEl.addEventListener('enter-vr', () => {
            leftHand.setAttribute('line', 'visible', true);
            rightHand.setAttribute('line', 'visible', true);
        });

        sceneEl.addEventListener('exit-vr', () => {
            leftHand.setAttribute('line', 'visible', false);
            rightHand.setAttribute('line', 'visible', false);
        });

        function focusOnObject(meshName) {
            const cam3D = cameraEl.object3D;
            const target = clickableObjects[meshName];
            if (!target) return;

            const box = new THREE.Box3().setFromObject(target);
            const center = box.getCenter(new THREE.Vector3());
            let pos;

            if (meshName.toLowerCase().includes('bed')) {
                pos = center.clone().add(new THREE.Vector3(0, 8, 0));
            } else {
                const dir = center.clone().sub(cam3D.position).normalize();
                const dist = zoomDistances[meshName] || zoomDistances['default'];
                pos = center.clone().add(dir.multiplyScalar(-dist));
            }

            const lookTarget = center.clone();
            new TWEEN.Tween(cam3D.position).to(pos, 1500).easing(TWEEN.Easing.Quadratic.Out).start();

            const temp = { t: 0 };
            const startQ = cam3D.quaternion.clone();
            const endQ = new THREE.Quaternion().setFromRotationMatrix(
                new THREE.Matrix4().lookAt(pos, lookTarget, new THREE.Vector3(0, 1, 0))
            );

            new TWEEN.Tween(temp).to({ t: 1 }, 1500).onUpdate(() => {
                cam3D.quaternion.copy(startQ).slerp(endQ, temp.t);
            }).easing(TWEEN.Easing.Quadratic.Out).start();

            backButton.style.display = "block";
        }

        backButton.addEventListener('click', () => {
            const cam3D = cameraEl.object3D;
            new TWEEN.Tween(cam3D.position).to(defaultCameraPos, 1500).easing(TWEEN.Easing.Quadratic.Out).start();

            const temp = { t: 0 };
            const startQ = cam3D.quaternion.clone();

            new TWEEN.Tween(temp).to({ t: 1 }, 1500).onUpdate(() => {
                cam3D.quaternion.copy(startQ).slerp(defaultCameraQuat, temp.t);
            }).easing(TWEEN.Easing.Quadratic.Out).start();

            backButton.style.display = "none";
            hideStory();
        });

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
        }
        animate();
    </script>
</body>

</html>