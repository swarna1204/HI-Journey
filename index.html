<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hyper Island Journey — Immersive A-Frame Experience</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #buttons {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
            flex-wrap: wrap;
            pointer-events: auto;
        }

        #backButton {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: none;
            pointer-events: auto;
        }

        .zoomButton {
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            color: #222831;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            opacity: 0.5;
            pointer-events: auto;
        }

        .zoomButton.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        #storyOverlay {
            display: none;
            position: fixed;
            left: 50%;
            top: 110px;
            transform: translateX(-50%);
            background: rgba(34, 40, 49, 0.95);
            color: #fff;
            font-size: 1.5rem;
            max-width: 80vw;
            padding: 1.3rem 2.3rem;
            border-radius: 18px;
            box-shadow: 0 4px 32px #111a;
            z-index: 99999 !important;
            text-align: center;
            letter-spacing: 0.03em;
            pointer-events: none;
        }

        /* VR Text Panel Styles */
        .vr-text-panel {
            width: 4;
            height: 2;
            background-color: rgba(34, 40, 49, 0.95);
            color: white;
            padding: 0.2;
            border-radius: 0.1;
            font-size: 0.15;
            text-align: center;
            visible: false;
        }
    </style>
</head>

<body>
    <div id="buttons">
        <div class="zoomButton" data-target="monitor001_3">Monitor</div>
        <div class="zoomButton" data-target="bed">Bed</div>
        <div class="zoomButton" data-target="houseplant_1">Plant</div>
        <div class="zoomButton" data-target="Rack001_1">YT Frame</div>
        <div class="zoomButton" data-target="Cylinder001">Wall Frame</div>
        <div class="zoomButton" data-target="Speaker_1">Speaker</div>
        <div class="zoomButton" data-target="Cube011_1">Light</div>
    </div>

    <div id="backButton">Back</div>
    <div id="storyOverlay"></div>

    <!-- Background Music: hidden audio, plays on user click -->
    <audio id="bg-music" src="audio/music.mp3" loop></audio>

    <a-scene id="scene" xr-mode-ui="enabled: true" cursor="rayOrigin: mouse" raycaster="objects: .clickable"
        renderer="antialias: true; precision: high;">
        <a-sky color="#222831"></a-sky>
        <a-entity light="type: ambient; intensity: 1"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="5 10 5"></a-entity>

        <!-- VR Text Panel with rounded corners using rounded-rectangle geometry -->
        <a-entity id="vrTextPanel" geometry="primitive: plane; width: 10; height: 3"
            material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="0 2 -3" visible="false">

            <!-- Rounded corner background using multiple overlapped planes -->
            <a-entity id="vrPanelBg" geometry="primitive: plane; width: 10; height: 3"
                material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="0 0 -0.001">
            </a-entity>

            <!-- Corner rounded elements -->
            <a-entity geometry="primitive: cylinder; radius: 0.3; height: 0.01; segmentsRadial: 8"
                material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="4.7 1.2 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.3; height: 0.01; segmentsRadial: 8"
                material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="-4.7 1.2 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.3; height: 0.01; segmentsRadial: 8"
                material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="4.7 -1.2 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.3; height: 0.01; segmentsRadial: 8"
                material="color: #222831; opacity: 0.95; transparent: true; shader: flat" position="-4.7 -1.2 0.001"
                rotation="90 0 0"></a-entity>

            <!-- Emoji and Title at the top -->
            <a-text id="vrEmojiTitle" value="" color="#ffffff" align="center" width="12" font="roboto"
                position="0 0.8 0.01" letter-spacing="1">
            </a-text>

            <!-- Main content text below -->
            <a-text id="vrContentText" value="" color="#ffffff" align="center" width="10" font="roboto"
                position="0 -0.3 0.01" letter-spacing="1" line-height="50" wrap-count="60">
            </a-text>
        </a-entity>

        <!-- VR Back Button with rounded corners -->
        <a-entity id="vrBackButton" geometry="primitive: plane; width: 1.8; height: 0.8"
            material="color: #ffffff; opacity: 0.95; shader: flat" position="0 0.3 -3" visible="false"
            class="clickable">

            <!-- Rounded corners for back button -->
            <a-entity geometry="primitive: cylinder; radius: 0.15; height: 0.01; segmentsRadial: 8"
                material="color: #ffffff; opacity: 0.95; transparent: true; shader: flat" position="0.75 0.25 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.15; height: 0.01; segmentsRadial: 8"
                material="color: #ffffff; opacity: 0.95; transparent: true; shader: flat" position="-0.75 0.25 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.15; height: 0.01; segmentsRadial: 8"
                material="color: #ffffff; opacity: 0.95; transparent: true; shader: flat" position="0.75 -0.25 0.001"
                rotation="90 0 0"></a-entity>
            <a-entity geometry="primitive: cylinder; radius: 0.15; height: 0.01; segmentsRadial: 8"
                material="color: #ffffff; opacity: 0.95; transparent: true; shader: flat" position="-0.75 -0.25 0.001"
                rotation="90 0 0"></a-entity>

            <a-text value="← Back" color="#000000" align="center" width="12" font="roboto" position="0 0 0.01">
            </a-text>
        </a-entity>

        <a-assets>
            <a-asset-item id="roomModel" src="model/model.glb"></a-asset-item>
        </a-assets>

        <a-entity id="model" gltf-model="#roomModel" position="-5 -10 -5" scale="10 10 10"></a-entity>

        <a-entity id="cameraRig" position="0 4 10">
            <a-camera look-controls wasd-controls></a-camera>
            <!-- Enhanced VR Controllers with proper raycaster setup including VR back button -->
            <a-entity id="rightController" laser-controls="hand: right"
                raycaster="objects: #model, #vrBackButton; recursive: true; far: 50"
                line="color: #ff0000; opacity: 0.8; visible: true">
            </a-entity>
            <a-entity id="leftController" laser-controls="hand: left"
                raycaster="objects: #model, #vrBackButton; recursive: true; far: 50"
                line="color: #0066ff; opacity: 0.8; visible: true">
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // Enable background music on first user click (browser policy fix)
        window.addEventListener('click', function enableAudio() {
            var audio = document.getElementById('bg-music');
            if (audio && audio.paused) {
                audio.play();
                window.removeEventListener('click', enableAudio);
            }
        });

        const sceneEl = document.querySelector('a-scene');
        const modelEl = document.querySelector('#model');
        const cameraEl = document.querySelector('#cameraRig');
        const zoomButtons = document.querySelectorAll('.zoomButton');
        const backButton = document.getElementById('backButton');
        const storyOverlay = document.getElementById('storyOverlay');
        const vrTextPanel = document.getElementById('vrTextPanel');
        const vrBackButton = document.getElementById('vrBackButton');
        const vrEmojiTitle = document.getElementById('vrEmojiTitle');
        const vrContentText = document.getElementById('vrContentText');
        const rightController = document.getElementById('rightController');
        const leftController = document.getElementById('leftController');
        const clickableObjects = {};

        let isInVR = false;
        let currentFocusedObject = null;

        const defaultCameraPos = new THREE.Vector3(0, 4, 10);
        const defaultCameraQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0));

        const zoomDistances = {
            'Speaker_1': 3,
            'Cube011_1': 4,
            'default': 3.5
        };

        // Story data with emoji and content separated
        const storyData = {
            bed: {
                emoji: "🛏️",
                title: "The Bed",
                content: "Balancing motherhood and ambition—my journey was about family as much as career."
            },
            monitor: {
                emoji: "💻",
                title: "The Monitor",
                content: "Countless late nights learning, coding, and applying for jobs. Every click was a step forward."
            },
            plant: {
                emoji: "🪴",
                title: "The Plant",
                content: "Roots take time. I was growing quietly in a new city, finding my place."
            },
            rack: {
                emoji: "🎬",
                title: "The YouTube Frame",
                content: "YouTube was my classroom and my comfort—where I learned to code, drew inspiration from creators, and found motivation in stories beyond the screen."
            },
            cylinder: {
                emoji: "🖼️",
                title: "The Wall Frame",
                content: "My wall frames capture moments of growth, lessons learned, obstacles faced, and milestones achieved—a daily reminder to pursue my dreams."
            },
            speaker: {
                emoji: "🔊",
                title: "The Speaker",
                content: "Podcasts and music kept me company, fueling resilience and hope."
            },
            cube011: {
                emoji: "💡",
                title: "The Light",
                content: "The light shines on my journey—filled with vision, hope, and new direction. At Hyper Island, I grew into a front-end developer. Now, I dream of taking my roots and wings to a product based company, blending UI/UX design with development and letting my ambitions soar."
            },
            cube: {
                emoji: "🟪",
                title: "Cube Object",
                content: "This is a generic cube in your scene."
            },
            default: {
                emoji: "✨",
                title: "Something in My Room",
                content: "This object is part of the story, but not a main scene highlight. Explore more!"
            }
        };

        // Detect VR mode changes
        sceneEl.addEventListener('enter-vr', () => {
            isInVR = true;
            console.log('Entered VR mode');
        });

        sceneEl.addEventListener('exit-vr', () => {
            isInVR = false;
            vrTextPanel.setAttribute('visible', false);
            vrBackButton.setAttribute('visible', false);
            console.log('Exited VR mode');
        });

        function showStory(text) {
            if (isInVR) {
                // This function is kept for compatibility but now uses showStoryForMesh for VR
                storyOverlay.innerHTML = text;
                storyOverlay.style.display = "block";
            } else {
                // Show desktop overlay
                storyOverlay.innerHTML = text;
                storyOverlay.style.display = "block";
            }
            console.log("showStory called with text:", text);
        }

        function hideStory() {
            if (isInVR) {
                vrTextPanel.setAttribute('visible', false);
                vrBackButton.setAttribute('visible', false);
            } else {
                storyOverlay.style.display = "none";
            }
        }

        // Enhanced story function for VR with proper emoji and text separation
        function showStoryForMesh(meshName) {
            if (!meshName) return;
            const lower = meshName.toLowerCase();
            console.log("showStoryForMesh called with:", meshName);

            let storyInfo;

            if (lower.includes("bed") || lower.includes("blanket") || lower.includes("pillow")) {
                storyInfo = storyData.bed;
            } else if (lower.includes("monitor")) {
                storyInfo = storyData.monitor;
            } else if (lower.includes("plant")) {
                storyInfo = storyData.plant;
            } else if (lower.includes("rack")) {
                storyInfo = storyData.rack;
            } else if (lower.includes("cylinder")) {
                storyInfo = storyData.cylinder;
            } else if (lower.includes("speaker")) {
                storyInfo = storyData.speaker;
            } else if (lower.includes("cube011")) {
                storyInfo = storyData.cube011;
            } else if (lower.includes("cube")) {
                storyInfo = storyData.cube;
            } else {
                storyInfo = storyData.default;
            }

            if (isInVR) {
                // Show VR text panel with emoji at top, content below
                vrEmojiTitle.setAttribute('value', `${storyInfo.emoji}  ${storyInfo.title}`);
                vrContentText.setAttribute('value', storyInfo.content);
                vrTextPanel.setAttribute('visible', true);
                vrBackButton.setAttribute('visible', true);
            } else {
                // Show desktop overlay with HTML formatting
                const htmlText = `${storyInfo.emoji} <b>${storyInfo.title}</b><br>${storyInfo.content}`;
                showStory(htmlText);
            }
        }

        // Disable buttons initially
        zoomButtons.forEach(button => {
            button.classList.remove('enabled');
        });

        // After model loads, map mesh names for click events and make them clickable
        modelEl.addEventListener('model-loaded', () => {
            const model = modelEl.getObject3D('mesh');
            model.traverse(node => {
                if (node.isMesh) {
                    clickableObjects[node.name] = node;
                    node.userData.clickable = true;
                    // Add clickable class to the mesh for raycaster detection
                    if (node.el) {
                        node.el.classList.add('clickable');
                    }
                }
            });

            // Also make the entire model clickable for VR
            modelEl.classList.add('clickable');

            zoomButtons.forEach(button => {
                button.classList.add('enabled');
            });

            setTimeout(() => {
                if (isInVR) {
                    vrEmojiTitle.setAttribute('value', "🌱  A New City, A New Start");
                    vrContentText.setAttribute('value', "My Hyper Island journey began here, where everything felt new and full of hope.");
                    vrTextPanel.setAttribute('visible', true);
                } else {
                    showStory("🌱 <b>A New City, A New Start</b><br><span style='font-size:1rem;opacity:0.82'>My Hyper Island journey began here, where everything felt new and full of hope.</span>");
                }
            }, 700);
        });

        // UI button interactions
        zoomButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!button.classList.contains('enabled')) return;
                const meshName = button.dataset.target;
                focusOnObject(meshName);
                showStoryForMesh(meshName);
            });
        });

        // Enhanced VR controller event handling
        function setupControllerEvents(controller) {
            // Handle trigger press events
            controller.addEventListener('triggerdown', function (evt) {
                console.log('VR trigger pressed');
                handleVRInteraction(controller);
            });

            // Handle trigger up events  
            controller.addEventListener('triggerup', function (evt) {
                console.log('VR trigger released');
            });

            // Handle grip press for alternative interaction
            controller.addEventListener('gripdown', function (evt) {
                console.log('VR grip pressed');
                handleVRInteraction(controller);
            });
        }

        function handleVRInteraction(controller) {
            const raycaster = controller.components.raycaster;
            if (!raycaster) {
                console.log('No raycaster found on controller');
                return;
            }

            const intersections = raycaster.intersections;
            console.log('VR intersections found:', intersections.length);

            if (intersections.length > 0) {
                const intersection = intersections[0];
                console.log('First intersection:', intersection);

                // Check if it's the VR back button
                if (intersection.object.el && intersection.object.el.id === 'vrBackButton') {
                    console.log('VR Back button triggered via intersection');
                    resetCamera();
                    return;
                }

                // Check if it's part of the model
                let meshName = intersection.object.name;
                if (!meshName && intersection.object.parent) {
                    // Try to find mesh name in parent hierarchy
                    let current = intersection.object;
                    while (current && !meshName) {
                        meshName = current.name;
                        current = current.parent;
                    }
                }

                console.log("VR interaction with mesh:", meshName);
                if (meshName && clickableObjects[meshName]) {
                    focusOnObject(meshName);
                    showStoryForMesh(meshName);
                } else {
                    console.log('No valid mesh name found for interaction');
                }
            } else {
                console.log('No intersections found');
            }
        }

        // Setup both controllers
        setupControllerEvents(rightController);
        setupControllerEvents(leftController);

        // VR Back Button functionality
        vrBackButton.addEventListener('triggerdown', () => {
            console.log('VR Back button trigger pressed');
            resetCamera();
        });

        vrBackButton.addEventListener('click', () => {
            console.log('VR Back button clicked');
            resetCamera();
        });

        // Enhanced click handling for VR controllers
        rightController.addEventListener('click', function (evt) {
            console.log('Right controller click event');
            handleVRClick(evt);
        });

        leftController.addEventListener('click', function (evt) {
            console.log('Left controller click event');
            handleVRClick(evt);
        });

        function handleVRClick(evt) {
            console.log('VR Click event triggered');

            // Check if clicking the VR back button
            if (evt.detail.intersection && evt.detail.intersection.object &&
                evt.detail.intersection.object.el === vrBackButton) {
                console.log('VR back button clicked');
                resetCamera();
                return;
            }

            // Get the controller that triggered the event
            const controller = evt.target;
            handleVRInteraction(controller);
        }

        // Desktop click handling (unchanged)
        modelEl.addEventListener('click', function (evt) {
            if (isInVR) return; // Skip desktop clicks in VR mode
            let meshName = evt.detail.intersection && evt.detail.intersection.object && evt.detail.intersection.object.name;
            console.log("Desktop Click detected. Name:", meshName);
            if (!meshName) return;
            focusOnObject(meshName);
            showStoryForMesh(meshName);
        });

        // Desktop mouse picking on scene background
        sceneEl.addEventListener('click', (e) => {
            if (isInVR) return; // Skip desktop clicks in VR mode
            if (e.target.closest('#buttons, #backButton')) return;
            const intersection = sceneEl.components.raycaster.getIntersection(modelEl);
            if (!intersection) return;
            const clickedName = intersection.object.name;
            focusOnObject(clickedName);
            showStoryForMesh(clickedName);
        });

        // Camera movement logic
        function focusOnObject(meshName) {
            currentFocusedObject = meshName;
            const cam3D = cameraEl.object3D;
            const targetMesh = clickableObjects[meshName];
            if (!targetMesh) {
                console.error("Object not found: " + meshName);
                return;
            }
            const box = new THREE.Box3().setFromObject(targetMesh);
            const center = box.getCenter(new THREE.Vector3());
            let newCameraPos, lookAtTarget;
            const lower = meshName.toLowerCase();

            if (lower.includes('cylinder')) {
                newCameraPos = center.clone().add(new THREE.Vector3(0, 0, 5));
                lookAtTarget = center.clone();
            }
            else if (lower.includes('bed')) {
                newCameraPos = center.clone().add(new THREE.Vector3(0, 8, 0));
                lookAtTarget = center.clone();
            }
            else if (lower.includes('cube011')) {
                newCameraPos = center.clone().add(new THREE.Vector3(0, 0, 4));
                lookAtTarget = center.clone();
            }
            else {
                const direction = center.clone().sub(cam3D.position).normalize();
                const zoomDistance = zoomDistances[meshName] || zoomDistances['default'];
                newCameraPos = center.clone().add(direction.multiplyScalar(-zoomDistance));
                lookAtTarget = center.clone();
            }

            new TWEEN.Tween(cam3D.position)
                .to({ x: newCameraPos.x, y: newCameraPos.y, z: newCameraPos.z }, 1500)
                .easing(TWEEN.Easing.Quadratic.Out)
                .start();

            const temp = { t: 0 };
            const startQuat = cam3D.quaternion.clone();
            const endQuat = new THREE.Quaternion().setFromRotationMatrix(
                new THREE.Matrix4().lookAt(newCameraPos, lookAtTarget, new THREE.Vector3(0, 1, 0))
            );

            new TWEEN.Tween(temp)
                .to({ t: 1 }, 1500)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => {
                    cam3D.quaternion.copy(startQuat).slerp(endQuat, temp.t);
                })
                .start();

            if (!isInVR) {
                backButton.style.display = "block";
            }
        }

        function resetCamera() {
            currentFocusedObject = null;
            const cam3D = cameraEl.object3D;
            new TWEEN.Tween(cam3D.position)
                .to({ x: defaultCameraPos.x, y: defaultCameraPos.y, z: defaultCameraPos.z }, 1500)
                .easing(TWEEN.Easing.Quadratic.Out)
                .start();
            const temp = { t: 0 };
            const startQuat = cam3D.quaternion.clone();
            const endQuat = defaultCameraQuat.clone();
            new TWEEN.Tween(temp)
                .to({ t: 1 }, 1500)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => {
                    cam3D.quaternion.copy(startQuat).slerp(endQuat, temp.t);
                })
                .start();

            if (!isInVR) {
                backButton.style.display = "none";
            }
            hideStory();
        }

        // Desktop back button
        backButton.addEventListener('click', resetCamera);

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
        }
        animate();
    </script>
</body>

</html>