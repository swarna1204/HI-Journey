<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hyper Island Journey ‚Äî Trigger-Zone Interaction</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial;
        }

        #buttons {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .zoomButton {
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            color: #222831;
            opacity: 0.5;
            cursor: pointer;
        }

        .zoomButton.enabled {
            opacity: 1;
        }

        #backButton {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: none;
            z-index: 1000;
        }

        #storyOverlay {
            display: none;
            position: fixed;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(34, 40, 49, 0.95);
            color: #fff;
            font-size: 1.5rem;
            max-width: 80vw;
            padding: 1.3rem 2.3rem;
            border-radius: 18px;
            box-shadow: 0 4px 32px #111a;
            text-align: center;
            z-index: 99999;
        }
    </style>
</head>

<body>

    <!-- UI for manual testing -->
    <div id="buttons">
        <div class="zoomButton" data-target="monitor001_3">Monitor</div>
        <div class="zoomButton" data-target="bed">Bed</div>
        <div class="zoomButton" data-target="houseplant_1">Plant</div>
        <div class="zoomButton" data-target="Rack001_1">YT Frame</div>
        <div class="zoomButton" data-target="Cylinder001">Wall Frame</div>
        <div class="zoomButton" data-target="Speaker_1">Speaker</div>
        <div class="zoomButton" data-target="Cube011_1">Light</div>
    </div>
    <div id="backButton">Back</div>
    <div id="storyOverlay"></div>
    <audio id="bg-music" src="audio/musicbg.mp3" loop></audio>

    <!-- trigger-zone component -->
    <script>
        AFRAME.registerComponent('trigger-zone', {
            schema: { radius: { type: 'number', default: 1 } },
            init: function () {
                this.cameraEl = document.querySelector('[camera]');
                this.inside = false;
            },
            tick: function () {
                const triggerPos = new THREE.Vector3();
                const camPos = new THREE.Vector3();
                this.el.object3D.getWorldPosition(triggerPos);
                this.cameraEl.object3D.getWorldPosition(camPos);
                const dist = triggerPos.distanceTo(camPos);
                if (dist < this.data.radius && !this.inside) {
                    this.inside = true;
                    const meshName = this.el.getAttribute('data-mesh-name');
                    window.handleMeshClick(meshName);
                } else if (dist >= this.data.radius && this.inside) {
                    this.inside = false;
                    // can hook exit logic here if desired
                }
            }
        });
    </script>

    <a-scene vr-mode-ui="enabled: true" renderer="antialias: true; precision: high;">
        <a-sky color="#222831"></a-sky>
        <a-entity light="type: ambient; intensity: 1"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="5 10 5"></a-entity>

        <a-assets>
            <a-asset-item id="roomModel" src="model/model.glb"></a-asset-item>
        </a-assets>

        <!-- Your room GLB -->
        <a-entity id="model" gltf-model="#roomModel" position="-5 -10 -5" scale="10 10 10">
        </a-entity>

        <!-- Camera Rig -->
        <a-entity id="cameraRig" position="0 4 10">
            <a-camera look-controls wasd-controls></a-camera>
        </a-entity>
    </a-scene>

    <script>
        // References
        const modelEl = document.getElementById('model');
        const zoomButtons = document.querySelectorAll('.zoomButton');
        const backButton = document.getElementById('backButton');
        const storyOverlay = document.getElementById('storyOverlay');
        const cameraRig3D = document.getElementById('cameraRig').object3D;
        const defaultPos = new THREE.Vector3(0, 4, 10);
        const defaultQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, 0, 0));

        // Play music on first click
        window.addEventListener('click', function once() {
            const a = document.getElementById('bg-music');
            if (a.paused) { a.play(); window.removeEventListener('click', once); }
        });

        // Show/hide story overlay
        function showStory(html) {
            storyOverlay.innerHTML = html;
            storyOverlay.style.display = 'block';
        }
        function hideStory() {
            storyOverlay.style.display = 'none';
        }

        // Choose story text based on mesh name
        function showStoryForMesh(name) {
            const l = name.toLowerCase();
            if (l.includes('bed')) {
                showStory('üõèÔ∏è <b>The Bed</b><br>Balancing motherhood and ambition‚Ä¶');
            } else if (l.includes('monitor')) {
                showStory('üíª <b>The Monitor</b><br>Late-night coding sessions‚Ä¶');
            } else if (l.includes('plant')) {
                showStory('ü™¥ <b>The Plant</b><br>Roots take time to grow.');
            } else {
                showStory('‚ú® <b>Discovery</b><br>Every object holds a story.');
            }
        }

        // Camera fly-to tween
        function focusOnObject(name) {
            const mesh = modelEl.getObject3D('mesh').getObjectByName(name);
            if (!mesh) return;
            const box = new THREE.Box3().setFromObject(mesh);
            const ctr = box.getCenter(new THREE.Vector3());
            const newPos = ctr.clone().add(new THREE.Vector3(0, 2, 5));

            new TWEEN.Tween(cameraRig3D.position)
                .to({ x: newPos.x, y: newPos.y, z: newPos.z }, 1200)
                .easing(TWEEN.Easing.Quadratic.Out)
                .start();

            const tmp = { t: 0 };
            const startQ = cameraRig3D.quaternion.clone();
            const endQ = new THREE.Quaternion().setFromRotationMatrix(
                new THREE.Matrix4().lookAt(newPos, ctr, new THREE.Vector3(0, 1, 0))
            );
            new TWEEN.Tween(tmp)
                .to({ t: 1 }, 1200)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => cameraRig3D.quaternion.copy(startQ).slerp(endQ, tmp.t))
                .start();

            backButton.style.display = 'block';
        }

        // Central handler
        window.handleMeshClick = function (meshName) {
            showStoryForMesh(meshName);
            focusOnObject(meshName);
        };

        // Create trigger volumes around each mesh
        modelEl.addEventListener('model-loaded', () => {
            const threeMesh = modelEl.getObject3D('mesh');
            threeMesh.updateMatrixWorld(true);
            threeMesh.traverse(node => {
                if (node.isMesh && node.name) {
                    const box3 = new THREE.Box3().setFromObject(node);
                    const size = box3.getSize(new THREE.Vector3());
                    const center = box3.getCenter(new THREE.Vector3());
                    // radius = ~60% of largest dimension
                    const radius = Math.max(size.x, size.y, size.z) * 0.6;
                    // create invisible box
                    const trigger = document.createElement('a-box');
                    trigger.setAttribute('width', size.x);
                    trigger.setAttribute('height', size.y);
                    trigger.setAttribute('depth', size.z);
                    trigger.setAttribute('position', `${center.x} ${center.y} ${center.z}`);
                    trigger.setAttribute('visible', 'false');
                    trigger.setAttribute('data-mesh-name', node.name);
                    trigger.setAttribute('trigger-zone', `radius: ${radius}`);
                    document.querySelector('a-scene').appendChild(trigger);
                }
            });
            // enable manual UI
            zoomButtons.forEach(b => b.classList.add('enabled'));
            // initial intro
            setTimeout(() => {
                showStory('üå± <b>A New City, A New Start</b><br>My journey began here.');
            }, 700);

            // Manual button fallback
            zoomButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!btn.classList.contains('enabled')) return;
                    window.handleMeshClick(btn.dataset.target);
                });
            });
        });

        // Back button resets camera & hides story
        backButton.addEventListener('click', () => {
            new TWEEN.Tween(cameraRig3D.position)
                .to({ x: defaultPos.x, y: defaultPos.y, z: defaultPos.z }, 1200)
                .easing(TWEEN.Easing.Quadratic.Out)
                .start();
            const tmp = { t: 0 }, startQ = cameraRig3D.quaternion.clone();
            new TWEEN.Tween(tmp)
                .to({ t: 1 }, 1200)
                .easing(TWEEN.Easing.Quadratic.Out)
                .onUpdate(() => cameraRig3D.quaternion.copy(startQ).slerp(defaultQuat, tmp.t))
                .start();
            hideStory();
            backButton.style.display = 'none';
        });

        // Animate loop for TWEEN
        (function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
        })();
    </script>
</body>

</html>